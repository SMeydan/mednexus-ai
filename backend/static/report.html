<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Medical Report - MedNexus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    class Header extends HTMLElement { connectedCallback() { this.innerHTML = '<div style="background:#064e3b; height:10px; width:100%;"></div>'; } }
    class Footer extends HTMLElement { connectedCallback() { this.innerHTML = '<div style="text-align:center; padding:20px; color:#9ca3af; font-size:0.8rem;">MedNexus AI Report System</div>'; } }
    customElements.define('med-header', Header);
    customElements.define('med-footer', Footer);
  </script>

  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #f0fdf4 0%, #dcfce7 100%);
      color: #1f2937;
      min-height: 100vh;
    }

    .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .page-title h1 { margin: 0; color: #064e3b; font-size: 1.8rem; font-weight: 800; }
    .page-title p { margin: 5px 0 0; color:#6b7280; }

    .action-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #10b981;
      background: white;
      color: #10b981;
      font-weight: 600;
      cursor: pointer;
      transition: 0.15s;
    }
    .action-btn:hover { background:#ecfdf5; transform:translateY(-2px); }
    .btn-print {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      box-shadow: 0 4px 10px rgba(16,185,129,0.3);
    }

    .report-card {
      background: #fff;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.03);
      border: 1px solid rgba(16,185,129,0.15);
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #047857;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Patient Info Styles */
    .patient-header { display: flex; gap: 25px; align-items: center; }
    .patient-photo { width: 100px; height: 100px; border-radius: 50%; border: 4px solid #d1fae5; object-fit: cover; background: #eee; }
    .patient-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; }
    .detail-label { font-size: .75rem; color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing: 0.5px; }
    .detail-value { font-size:1.1rem; font-weight:700; color: #111; }

    /* Metrics Grid & Icons */
    .metrics-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
      gap: 20px; 
    }
    
    .metric-box { 
      background: #fff; 
      text-align: left; 
      padding: 20px; 
      border-radius: 12px; 
      border: 1px solid #e5e7eb; 
      position: relative;
      overflow: hidden;
      transition: transform 0.2s;
    }
    .metric-box:hover { transform: translateY(-3px); border-color: #10b981; }

    .metric-icon-bg {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 40px;
      height: 40px;
      background: #ecfdf5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #059669;
    }
    
    .metric-label { font-size: 0.85rem; color: #6b7280; font-weight: 500; margin-bottom: 5px; }
    .metric-value { font-size: 1.4rem; font-weight: 800; color: #064e3b; }
    .metric-sub { font-size: 0.75rem; color: #9ca3af; margin-top: 2px; }

    /* Images */
    .images-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:20px; }
    .medical-img { width:100%; height:200px; object-fit:cover; border-radius:10px; background: #f3f4f6; }

    /* Summary & Risk */
    .report-text {
      background:#f0fdf4;
      padding:25px;
      border-radius:10px;
      border:1px solid #bbf7d0;
      white-space:pre-wrap;
      font-size:.95rem;
      color:#166534;
      line-height:1.7;
    }

    .risk-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 10px;
    }
    
    .risk-box {
      background: #fff;
      border: 1px solid #fee2e2;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .risk-box.low { border-color: #bbf7d0; background: #f0fdf4; }
    .risk-box.moderate { border-color: #fde68a; background: #fffbeb; }
    .risk-box.high { border-color: #fecaca; background: #fef2f2; }

    .risk-percent { font-size: 2rem; font-weight: 800; display: block; }
    .risk-label { font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 5px; display: block;}
    .risk-diag { font-size: 0.8rem; padding: 4px 8px; border-radius: 20px; display: inline-block; margin-top: 5px;}

    @media print {
      body { background:white; }
      med-header, med-footer, .action-btn { display:none !important; }
      .report-card { box-shadow:none; border:1px solid #ddd; break-inside: avoid; }
    }
  </style>
</head>

<body>

<med-header></med-header>

<div class="container">

  <div class="page-header">
    <div class="page-title">
      <h1>Medical Report</h1>
      <p>Generated on: <span id="currentDate"></span></p>
    </div>

    <div style="display:flex; gap:10px;">
      <button class="action-btn" onclick="history.back()">← Back</button>
      <button class="action-btn btn-print" onclick="window.print()">Export PDF</button>
    </div>
  </div>

  <div class="report-card">
    <div class="card-title">Patient Information</div>
    <div class="patient-header">
      <img id="p_photo" class="patient-photo" src="/static/imgs/default.png" onerror="this.src='https://placehold.co/100'">
      <div class="patient-details">
        <div>
          <span class="detail-label">Full Name</span>
          <div class="detail-value" id="p_name">...</div>
        </div>
        <div>
          <span class="detail-label">National ID</span>
          <div class="detail-value" id="p_id">...</div>
        </div>
        <div>
          <span class="detail-label">Age / Gender</span>
          <div class="detail-value" id="p_age_gender">...</div>
        </div>
        <div style="grid-column: span 3;">
             <span class="detail-label">Presenting Complaint</span>
             <div class="detail-value" style="font-weight: 500;" id="p_complaint">...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="report-card">
    <div class="card-title">
        Clinical Knowledge & Metrics
    </div>
    <div class="metrics-grid" id="metricsGrid">
       </div>
  </div>

  <div class="report-card" id="imagesCard" style="display:none;">
    <div class="card-title">Medical Imaging</div>
    <div class="images-grid" id="imagesGrid"></div>
  </div>

  <div class="report-card">
    <div class="card-title">AI Clinical Summary</div>
    <div class="report-text" id="summaryText">Loading summary...</div>
  </div>

  <div class="report-card">
    <div class="card-title">Risk Assessment Analysis</div>
    <div id="riskSection" class="risk-container">
        </div>
  </div>

</div>

<med-footer></med-footer>

<script>
// --- ICONS (SVG Strings) ---
const icons = {
    glucose: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.6 18.6L12 12l-6.6 6.6a9 9 0 0 1 0-12.72l6.6 6.6 6.6-6.6a9 9 0 0 1 0 12.72z"></path></svg>`,
    bmi: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.91 8.84 8.56 2.23a1.93 1.93 0 0 0-1.81 0L3.1 4.13a2.12 2.12 0 0 0-.05 4.25l4.2.09 2.2 2.2a2 2 0 0 0 2.83 0l2.17-2.17a2 2 0 0 1 2.83 0l3.64 3.63a2 2 0 0 0 2.82 0l2-2a2.11 2.11 0 0 0 .09-4.21z"></path></svg>`,
    heart: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`,
    smoking: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8c0-2.5-2-2.5-2-5"/><path d="M22 8c0-2.5-2-2.5-2-5"/><path d="M2 21h16a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1H2v6Z"/><path d="M16 18h2"/><path d="M14 18h2"/></svg>`,
    activity: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 4a2 2 0 1 0-2-2 2 2 0 0 0 2 2Z"/><path d="M12 9v5"/><path d="M5.5 9.5 9 12l2 4 4-2.5 1.5 3"/><path d="M14 12l1-4h3.5"/></svg>`,
    blood: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21a9 9 0 0 0 0-18c-4.97 0-9 4.03-9 9 0 0 0 9 9z"/><path d="M12 3v9"/><path d="M12 12l4.5 4.5"/></svg>`,
    stress: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>`,
    alcohol: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 22h8"/><path d="M7 10h10"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/></svg>`
};

const params = new URLSearchParams(window.location.search);
const id = params.get("patient_id");

document.getElementById("currentDate").textContent = new Date().toLocaleDateString();

async function loadReport() {

  const res = await fetch(`/api/report/${id}`);
  const data = await res.json();

  const p = data.patient;
  document.getElementById("p_name").textContent = p.full_name;
  document.getElementById("p_id").textContent = p.national_id;
  document.getElementById("p_age_gender").textContent = `${p.age} / ${p.gender}`;
  document.getElementById("p_complaint").textContent = p.complaint;

  // METRICS
  const k = data.knowledge || {};
  const h = data.heart || {};

  let metricsHtml = "";

  const createMetric = (label, value, sub, iconKey) => `
    <div class="metric-box">
        <div class="metric-icon-bg">${icons[iconKey] || icons.blood}</div>
        <div class="metric-label">${label}</div>
        <div class="metric-value">${value}</div>
        <div class="metric-sub">${sub}</div>
    </div>
  `;

  metricsHtml += createMetric("Glucose", k.glucose || "-", "mg/dL", "glucose");
  metricsHtml += createMetric("BMI", k.bmi || "-", "Index", "bmi");
  metricsHtml += createMetric("HbA1c", k.hba1c || "-", "%", "blood");

  if (h.systolic_bp || h.diastolic_bp)
    metricsHtml += createMetric("Blood Pressure", `${h.systolic_bp}/${h.diastolic_bp}`, "mmHg", "heart");

  if (h.heart_rate)
    metricsHtml += createMetric("Heart Rate", h.heart_rate, "bpm", "heart");

  const smokeVal = k.smoking ? "Yes" : "No";
  const smokeSub = k.smoking ? `${k.cigarettes_per_day} cigs/day` : "Non-smoker";

  metricsHtml += createMetric("Smoking", smokeVal, smokeSub, "smoking");
  metricsHtml += createMetric("Physical Activity", k.physical_activity ? "Active" : "Sedentary", "Lifestyle", "activity");
  metricsHtml += createMetric("Alcohol", k.alcohol ? "Yes" : "No", "Consumption", "alcohol");
  metricsHtml += createMetric("Stress", k.stress ? "High" : "Normal", "Self reported", "stress");

  document.getElementById("metricsGrid").innerHTML = metricsHtml;

  // IMAGES
if (data.images?.length > 0) {

    // PROFILE resmi
    const profileImg = data.images.find(
        img => img.disease?.toLowerCase() === "profile"
    );

    document.getElementById("p_photo").src =
        profileImg?.image_path || "/static/imgs/default.png";

    // MEDICAL IMAGES (profile hariç)
    const medicalImages = data.images.filter(
        img => img.disease?.toLowerCase() !== "profile"
    );

    if (medicalImages.length > 0) {
        document.getElementById("imagesCard").style.display = "block";

        let imgsHtml = "";
        medicalImages.forEach(img => {
            imgsHtml += `
                <div>
                  <img class="medical-img" src="${img.image_path}">
                  <div style="text-align:center; margin-top:5px; font-size:0.9rem;">
                      ${img.disease ?? "Scan"}
                  </div>
                </div>
            `;
        });

        document.getElementById("imagesGrid").innerHTML = imgsHtml;
    }
}

  // SUMMARY
let summaryBox = document.getElementById("summaryText");
let rs = data.result;

let visual = {};
try {
    visual = JSON.parse(r.result);
} catch {}

// HTML oluştur
let summaryHtml = `
  <div style="margin-bottom:20px;">
      <strong style="color:#064e3b; font-size:1.1rem;">Diabetes Risk</strong><br>
      <span style="font-size:1.4rem; font-weight:800;">${(rs.diabetes_risk*100).toFixed(1)}%</span><br>
      <em style="color:#047857;">${rs.diabetes_diagnosis}</em>
  </div>

  <div style="margin-bottom:20px;">
      <strong style="color:#064e3b; font-size:1.1rem;">Hypertension Risk</strong><br>
      <span style="font-size:1.4rem; font-weight:800;">${(rs.hypertension_risk*100).toFixed(1)}%</span><br>
      <em style="color:#047857;">${rs.hypertension_diagnosis}</em>
  </div>

  <div style="margin-bottom:20px;">
      <strong style="color:#064e3b; font-size:1.1rem;">Heart Disease Risk</strong><br>
      <span style="font-size:1.4rem; font-weight:800;">${(rs.heart_disease_risk*100).toFixed(1)}%</span><br>
      <em style="color:#047857;">${rs.heart_disease_diagnosis}</em>
  </div>
`;


// Visual model çıktılarını ekle
for (let key in visual) {
    summaryHtml += `
        <div style="margin-bottom:20px;">
            <strong style="color:#064e3b; font-size:1.1rem;">
                ${key.replace(/_/g," ").toUpperCase()}
            </strong><br>
            <span style="font-size:1.4rem; font-weight:800;">
                ${(visual[key] * 100).toFixed(1)}%
            </span>
        </div>
    `;
}

summaryBox.innerHTML = summaryHtml;


  // RISKS
  const r = data.result;

  const getRiskClass = (diagnosis) => {
      const d = diagnosis.toLowerCase();
      if (d.includes("high")) return "high";
      if (d.includes("moderate") || d.includes("borderline")) return "moderate";
      return "low";
  };

  document.getElementById("riskSection").innerHTML = `
    <div class="risk-box ${getRiskClass(r.diabetes_diagnosis)}">
        <span class="risk-label">Diabetes Risk</span>
        <span class="risk-percent">${(r.diabetes_risk * 100).toFixed(4)}%</span>
        <span class="risk-diag">${r.diabetes_diagnosis}</span>
    </div>
    <div class="risk-box ${getRiskClass(r.hypertension_diagnosis)}">
        <span class="risk-label">Hypertension Risk</span>
        <span class="risk-percent">${(r.hypertension_risk * 100).toFixed(4)}%</span>
        <span class="risk-diag">${r.hypertension_diagnosis}</span>
    </div>
    <div class="risk-box ${getRiskClass(r.heart_disease_diagnosis)}">
        <span class="risk-label">Heart Disease Risk</span>
        <span class="risk-percent">${(r.heart_disease_risk * 100).toFixed(4)}%</span>
        <span class="risk-diag">${r.heart_disease_diagnosis}</span>
    </div>
  `;
}

loadReport();
</script>


</body>
</html>